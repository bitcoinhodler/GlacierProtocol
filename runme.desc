#!/bin/bash

set -e

bitcoind -regtest -connect=0.0.0.0 -daemon
sleep 5

echo createwallet
bitcoin-cli -regtest -named createwallet wallet_name= descriptors=true

echo decodescript
bitcoin-cli -regtest decodescript 52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654ae


# Instead of getaddressinfo can we figure all that out from the descriptor?
# Because we can't import it yet (or else privkeys won't import successfully)

echo getdescriptorinfo to get pubkey for 1st privkey
bitcoin-cli -regtest getdescriptorinfo \
  "pkh(cSfvoUsWWZ81M4qGYciPHdNxHXQxPEsXBdGWjYdchpisPabtiKVQ)"

# The pubkey is displayed in the "descriptor" returned by getdescriptorinfo:
#   "descriptor": "pkh(0277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113)#7d2u80af",


echo getdescriptorinfo to get pubkey for 2nd privkey
bitcoin-cli -regtest getdescriptorinfo \
  "pkh(cPWVKeCBjnv833Kayc6nczBbG4YqqbCucup3n5D68WPzBEfceBAQ)"

# The pubkey is displayed in the "descriptor" returned by getdescriptorinfo:
#  "descriptor": "pkh(0203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac)#alaa56tl",

# Replace the appropriate 2 of the pubkeys in the descriptor with our privkeys.

echo getdescriptorinfo to get checksum
bitcoin-cli -regtest getdescriptorinfo \
  "sh(multi(2,cSfvoUsWWZ81M4qGYciPHdNxHXQxPEsXBdGWjYdchpisPabtiKVQ,cPWVKeCBjnv833Kayc6nczBbG4YqqbCucup3n5D68WPzBEfceBAQ,026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c6,039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff6))"

echo importdescriptors
bitcoin-cli -regtest importdescriptors '[{
  "desc": "sh(multi(2,cSfvoUsWWZ81M4qGYciPHdNxHXQxPEsXBdGWjYdchpisPabtiKVQ,cPWVKeCBjnv833Kayc6nczBbG4YqqbCucup3n5D68WPzBEfceBAQ,026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c6,039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff6))#lypu83k3",
  "timestamp": "now"
}]'



echo createrawtransaction
bitcoin-cli -regtest createrawtransaction '[{
  "amount": "0.00005000",
  "redeemScript": "52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654ae",
  "scriptPubKey": "a914606fb72624603795d73b911a729d88f95f9b6ac887",
  "txid": "840e40fd2f0c876d99859040d848c7a6ecced6fda449b7de1e7315cea43d61e1",
  "vout": 1
}]' '{
  "2N238gpicqPFfMz8sUN7pqqaJnYkgsC1WmL": 0,
  "mp1KQzUoDf9div7jjgon3UuqLThMSo3tmF": 0}' 0 false


echo signrawtransactionwithwallet
bitcoin-cli -regtest signrawtransactionwithwallet \
  0200000001e1613da4ce15731edeb749a4fdd6ceeca6c748d8409085996d870c2ffd400e840100000000ffffffff02000000000000000017a914606fb72624603795d73b911a729d88f95f9b6ac88700000000000000001976a9145d1e4870ab9df56432aa357021fd0a15a7094ad188ac00000000 \
  '[{
  "amount": "0.00005000",
  "redeemScript": "52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654ae",
  "scriptPubKey": "a914606fb72624603795d73b911a729d88f95f9b6ac887",
  "txid": "840e40fd2f0c876d99859040d848c7a6ecced6fda449b7de1e7315cea43d61e1",
  "vout": 1
}]'


echo decoderawtransaction
bitcoin-cli -regtest decoderawtransaction \
  0200000001e1613da4ce15731edeb749a4fdd6ceeca6c748d8409085996d870c2ffd400e8401000000fd1e010047304402205c62f3ccafaa22ae4dbc24708438a4a5f3a4f99e6c16753168e150f104f56e3502206686d18096fe2ce49693ae27e01c5b8396ab0a49ab6d43b6340827c71730d3c9014730440220638f47f475c2714549e6dd4bb0f6c211f58b2342d119926bd3cd67e1bef44f2b02207cf942d764711eba2328f6d124194e8d576a849c5092e2f2c38d527c5f00c2bd014c8b52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654aeffffffff02000000000000000017a914606fb72624603795d73b911a729d88f95f9b6ac88700000000000000001976a9145d1e4870ab9df56432aa357021fd0a15a7094ad188ac00000000

echo createrawtransaction
bitcoin-cli -regtest createrawtransaction '[{
  "amount": "0.00005000",
  "redeemScript": "52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654ae",
  "scriptPubKey": "a914606fb72624603795d73b911a729d88f95f9b6ac887",
  "txid": "840e40fd2f0c876d99859040d848c7a6ecced6fda449b7de1e7315cea43d61e1",
  "vout": 1
}]' '{
  "2N238gpicqPFfMz8sUN7pqqaJnYkgsC1WmL": "0.00002380",
  "mp1KQzUoDf9div7jjgon3UuqLThMSo3tmF": "0.00001000"
}' 0 false


echo signrawtransactionwithwallet
bitcoin-cli -regtest signrawtransactionwithwallet \
  0200000001e1613da4ce15731edeb749a4fdd6ceeca6c748d8409085996d870c2ffd400e840100000000ffffffff024c0900000000000017a914606fb72624603795d73b911a729d88f95f9b6ac887e8030000000000001976a9145d1e4870ab9df56432aa357021fd0a15a7094ad188ac00000000 \
  '[{
  "amount": "0.00005000",
  "redeemScript": "52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654ae",
  "scriptPubKey": "a914606fb72624603795d73b911a729d88f95f9b6ac887",
  "txid": "840e40fd2f0c876d99859040d848c7a6ecced6fda449b7de1e7315cea43d61e1",
  "vout": 1
}]'

echo decoderawtransaction
bitcoin-cli -regtest decoderawtransaction \
  0200000001e1613da4ce15731edeb749a4fdd6ceeca6c748d8409085996d870c2ffd400e8401000000fd1e010047304402207cad4fcb8b71bd486a614645db3f751c1a22b1301502cc5d0a9d00d98ea41c65022007aad9ed8b09c6b16d56cca2d99ec6a79cc240306403beca3cb9e2173d8d2cb60147304402200c1dcdbf884abbf1677082ec1b9a2f50d1f15a24d7156310c77d45285e35a7c602202cbb9a0cfc80b32d8243d8140437a8aaf0af27b28baa6ea7beb6b020f2d95267014c8b52210277f15f22aeffaf3f3bc48a280a767f7c6af21276783c09ff3bcaabbece178113210203f642223bc751e125ab604ed20c544e933eb82a19201f90bda6236a9ddbedac21026895f3ed01c09025ba9cfab7b67d699e3ebaceada0beff70bc72c7f10df2d1c621039f3cb152130c241e01b9220a147f69f7111b830def35b510973ab47bb9af7ff654aeffffffff024c0900000000000017a914606fb72624603795d73b911a729d88f95f9b6ac887e8030000000000001976a9145d1e4870ab9df56432aa357021fd0a15a7094ad188ac00000000


echo stop
bitcoin-cli -regtest stop
sleep 2
rm -rf ~/.bitcoin
